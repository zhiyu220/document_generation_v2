<div id="chat-widget">
  <div id="chat-toggle" onclick="toggleChat()">ğŸ¤–</div>
  <div id="chat-window">
    <div id="chat-header">
      <span>å‚™å¯© Q&A åŠ©ç†</span>
      <button onclick="toggleChat()">âœ–</button>
    </div>
    <div id="chat-body"></div>

    <div id="chat-selects">
      <select id="chat-university">
        <option value="">è«‹é¸æ“‡å­¸æ ¡</option>
      </select>
      <select id="chat-department">
        <option value="">è«‹é¸æ“‡å­¸ç³»</option>
      </select>
    </div>
    <div id="chat-input-box">
      <input
        type="text"
        id="chat-input"
        placeholder="è«‹è¼¸å…¥ä½ çš„å•é¡Œ..."
        onkeypress="if(event.key==='Enter') sendMessage()"
      />
      <button onclick="sendMessage()">é€å‡º</button>
    </div>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    let selectedUniversity = "";
    let selectedDepartment = "";
    let schoolData = {};

    async function loadSchoolsAndDepartments() {
      const schoolSelect = document.getElementById("chat-university");
      const departmentSelect = document.getElementById("chat-department");

      try {
        // Only load universities initially
        const uniResponse = await fetch("/get_universities");
        const universities = await uniResponse.json();

        // Clear and populate university select
        schoolSelect.innerHTML = '<option value="">è«‹é¸æ“‡å­¸æ ¡</option>';
        universities.forEach(uni => {
          const option = document.createElement("option");
          option.value = uni;
          option.textContent = uni;
          schoolSelect.appendChild(option);
        });

        // Add change event listener to load departments only when university is selected
        schoolSelect.onchange = async () => {
          const selectedSchool = schoolSelect.value;
          departmentSelect.innerHTML = '<option value="">è«‹é¸æ“‡å­¸ç³»</option>';
          
          if (selectedSchool) {
            try {
              const deptResponse = await fetch(`/get_departments?university=${encodeURIComponent(selectedSchool)}`);
              const departments = await deptResponse.json();
              
              departments.forEach(dept => {
                const deptOption = document.createElement("option");
                deptOption.value = dept;
                deptOption.textContent = dept;
                departmentSelect.appendChild(deptOption);
              });
            } catch (error) {
              console.error("Error loading departments:", error);
            }
          }
        };

      } catch (error) {
        console.error("Error loading universities:", error);
      }
    }

    // Initial load
    loadSchoolsAndDepartments();

    window.toggleChat = function () {
      const chatWindow = document.getElementById("chat-window");
      if (chatWindow.classList.contains("show")) {
        chatWindow.classList.remove("show");
      } else {
        chatWindow.classList.add("show");
      }
    };

    function appendMessage(text, sender = "bot", isLoading = false) {
      const msg = document.createElement("div");
      msg.className = `message ${sender}`;
      if (isLoading) msg.dataset.loading = "true";

      // æ¸…é™¤ Markdown æ¨™è¨˜
      let cleaned = text
        .replace(/\*\*/g, "") // **ç²—é«”**
        .replace(/`/g, "") // `ç¨‹å¼ç¢¼`
        .replace(/[_~#>]/g, "") // å…¶ä»–ç¬¦è™Ÿ
        .replace(/\n{2,}/g, "\n") // å¤šé‡æ›è¡Œç°¡åŒ–æˆä¸€å€‹

        // é‡è¦ï¼šå°‡ A - ...ã€1. ...ã€B - ... å¼·åˆ¶æ–·è¡Œ
        .replace(/([A-Z])\s*-\s*/g, "\n$1 - ")
        .replace(/(\d+)\.\s*/g, "\n$1. ");

      // æ‹†æˆè¡Œï¼Œè½‰ç‚ºæ®µè½æˆ–æ¸…å–®
      const lines = cleaned.split("\n");
      const formattedLines = [];
      let inList = false;

      lines.forEach((line) => {
        const trimmed = line.trim();
        if (!trimmed) return;

        if (/^(\d+\.\s|[A-Z]-\s)/.test(trimmed)) {
          if (!inList) {
            formattedLines.push("<ul>");
            inList = true;
          }
          formattedLines.push(
            `<li>${trimmed.replace(/^(\d+\.\s|[A-Z]-\s)/, "")}</li>`
          );
        } else {
          if (inList) {
            formattedLines.push("</ul>");
            inList = false;
          }
          formattedLines.push(`<p>${trimmed}</p>`);
        }
      });
      if (inList) formattedLines.push("</ul>");

      msg.innerHTML = formattedLines.join("\n");
      document.getElementById("chat-body").appendChild(msg);
      document.getElementById("chat-body").scrollTop =
        document.getElementById("chat-body").scrollHeight;
    }

    window.sendMessage = function () {
      const input = document.getElementById("chat-input");
      const text = input.value.trim();
      if (!text || !selectedUniversity || !selectedDepartment) {
        appendMessage("â— è«‹å…ˆé¸æ“‡å­¸æ ¡èˆ‡å­¸ç³»ï¼Œå†è¼¸å…¥å•é¡Œï¼", "bot");
        return;
      }
      appendMessage(text, "user");
      input.value = "";
      appendMessage("â³ å›è¦†ä¸­...", "bot", true);

      fetch("/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          university: selectedUniversity,
          department: selectedDepartment,
          question: text,
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          document
            .querySelectorAll(".message.bot[data-loading='true']")
            .forEach((msg) => msg.remove());
          appendMessage(data.answer || "âš ï¸ å›è¦†å¤±æ•—", "bot");
        });
    };
  });
</script>
