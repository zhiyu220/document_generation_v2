{% extends "base.html" %} {% block title %}備審段落生成器{% endblock %} {% block
content %}

<!-- 添加 Mermaid -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
  // 定義段落代碼對應
  const CODE_MAPPING = {
    "A": "修課紀錄",
    "B": "書面報告",
    "C": "實作作品",
    "D": "自然科學探究",
    "E": "社會領域探究",
    "F": "高中自主學習計畫",
    "G": "社團活動經驗",
    "H": "幹部經驗",
    "I": "服務學習經驗",
    "J": "競賽表現",
    "K": "非修課成果作品",
    "L": "檢定證照",
    "M": "特殊優良表現",
    "N": "多元表現綜整心得",
    "O": "高中學習歷程反思",
    "P": "學習動機",
    "Q": "未來學習計畫"
  };

  // 定義段落分組
  const SECTION_MAPPING = {
    ABC: { 
      codes: ["A", "B", "C", "D", "E"],
      prompt: "請撰寫一篇課程學習成果，強調學習歷程與探索精神，並與學系關聯性相結合。"
    },
    N: { 
      codes: ["F", "G", "H", "I", "J", "K", "L", "M"],
      prompt: "請了解學系專業與選材理念後，撰寫強調自主學習的多元表現綜整心得。"
    },
    O: { 
      codes: ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M"],
      prompt: "請撰寫高中學習歷程反思，強調學習經驗、挑戰與成長。"
    },
    P: { 
      codes: ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M"],
      prompt: "請撰寫學習動機，強調與學系高度相關的興趣與企圖心。"
    },
    Q: { 
      codes: ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M"],
      prompt: "請撰寫未來計畫，分成三個階段：入學前、就讀期間、畢業後。"
    }
  };

  // 初始化 Mermaid
  mermaid.initialize({
    startOnLoad: false,
    theme: 'default',
    securityLevel: 'loose',
    mindmap: {
      padding: 20,
      useMaxWidth: true
    },
    logLevel: 'error'
  });

  mermaid.initialize({
    startOnLoad: false,
    theme: 'default',
    securityLevel: 'loose',
    mindmap: {
      padding: 20,
      useMaxWidth: true
    },
    logLevel: 'error'
  });
</script>

<!-- 添加 Monaco Editor -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.js"></script>

<!-- Loading Overlay -->
<div id="loading-overlay">
  <div id="loading-spinner">
    <svg class="loading-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path>
    </svg>
    <svg class="hourglass-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
      <path d="M22 2H2v6h20V2zM22 16H2v6h20v-6zM12 2v20M7 2s2.5 6 5 6 5-6 5-6M7 22s2.5-6 5-6 5 6 5 6"></path>
    </svg>
    <span class="loading-text">處理中...</span>
  </div>
</div>

<div id="quota-check-wrapper" style="display: none">
  <div class="generator-container">
    <h2>🛠️ 備審段落生成器</h2>

    <div class="form-group">
      <label for="university">選擇學校：</label>
      <select id="university" class="form-control"></select>
    </div>

    <div class="form-group">
      <label for="department">選擇學系：</label>
      <select id="department" class="form-control"></select>
    </div>

    <button onclick="loadGuidelines()" class="btn btn-primary">確認</button>

    <hr />

    <div class="form-group">
      <label for="section_code">📄 欲生成段落</label>
      <select id="section_code" class="form-control" onchange="updateFieldsBasedOnSelection()">
        <option value="" selected>請選擇要生成的段落</option>
        <option value="ABC">課程學習成果</option>
        <option value="N">多元表現綜整</option>
        <option value="O">學習歷程反思</option>
        <option value="P">學習動機</option>
        <option value="Q">未來計畫</option>
      </select>
    </div>

    <div id="fields"></div>

    <div class="form-group">
      <label for="style">📝 報告風格</label>
      <select id="style" class="form-control">
        <option value="formal">正式</option>
        <option value="casual">口語</option>
        <option value="concise">簡潔</option>
        <option value="detailed">深入分析</option>
      </select>
    </div>

    <button onclick="generateParagraph()" class="btn btn-success">生成</button>

    <div class="result-section">
      <h3>📄 生成結果</h3>
      <div class="result-layout">
        <!-- 上方心智圖區域 -->
        <div class="mindmap-layout">
          <div class="mindmap-editor-panel">
            <h4>✏️ 編輯心智圖</h4>
            <div id="mindmap-editor"></div>
            <button onclick="updateMindmap()" class="btn btn-primary update-mindmap-btn">更新心智圖</button>
          </div>
          <div class="mindmap-preview-panel">
            <h4>📊 心智圖預覽</h4>
            <div id="mindmap-content" class="mindmap-container"></div>
          </div>
        </div>
        <!-- 下方生成內容 -->
        <div id="output" class="output-section"></div>
      </div>
      <button id="download-docx" class="btn btn-secondary" onclick="downloadDocx()">
        📥 下載 Word
      </button>
    </div>

    <!-- 在生成結果部分添加心智圖編輯器 -->
    <div class="mindmap-editor-container" style="display: none;">
      <h3>📝 心智圖編輯器</h3>
      <div class="editor-wrapper">
        <div id="mindmap-editor" style="height: 300px; border: 1px solid #ddd;"></div>
        <div class="preview-wrapper">
          <h4>預覽</h4>
          <div id="mindmap-preview" class="mindmap-container"></div>
        </div>
      </div>
      <button class="btn btn-primary" onclick="updateMindmap()">更新心智圖</button>
    </div>
  </div>
</div>

<style>
.generator-container {
  max-width: 800px;
  margin: 0;
  padding: 20px;
}

.form-group {
  margin-bottom: 20px;
}

.form-control {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  margin-top: 5px;
}

.btn {
  padding: 8px 16px;
  margin: 5px;
  border-radius: 4px;
  cursor: pointer;
}

.btn-primary {
  background-color: #007bff;
  color: white;
  border: none;
}

.btn-success {
  background-color: #28a745;
  color: white;
  border: none;
}

.btn-secondary {
  background-color: #6c757d;
  color: white;
  border: none;
}

textarea.form-control {
  min-height: 150px;
  font-size: 16px;
  line-height: 1.6;
  padding: 12px;
  background: white;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  resize: vertical;
}

.upload-container {
  background-color: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
  margin-top: 15px;
  border: 1px solid #dee2e6;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.upload-instructions {
  margin-bottom: 20px;
  padding: 15px;
  background-color: #fff;
  border-radius: 5px;
  border-left: 4px solid #007bff;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.input-section {
  background: white;
  padding: 20px;
  border-radius: 8px;
  border: 1px solid #dee2e6;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  margin-bottom: 20px;
}

.char-count {
  color: #666;
  font-size: 14px;
  text-align: right;
  margin-top: 5px;
  padding: 5px;
}

.section-title {
  font-size: 16px;
  font-weight: 500;
  color: #495057;
  margin-bottom: 10px;
}

#loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.9);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  backdrop-filter: blur(5px);
}

#loading-spinner {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(255, 255, 255, 0.95);
  padding: 20px 30px;
  border-radius: 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  font-size: 16px;
  color: #333;
  display: flex;
  align-items: center;
  gap: 12px;
  z-index: 1001;
  border: 1px solid rgba(0, 0, 0, 0.1);
  min-width: 200px;
  justify-content: center;
  animation: fadeIn 0.3s ease;
}

body.loading {
  overflow: hidden;
}

.loading-icon {
  animation: spin 1s linear infinite;
  width: 24px;
  height: 24px;
}

.hourglass-icon {
  width: 24px;
  height: 24px;
  animation: flip 2s infinite;
}

.loading-text {
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

@keyframes pulse {
  0% { opacity: 0.6; }
  50% { opacity: 1; }
  100% { opacity: 0.6; }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translate(-50%, -48%); }
  to { opacity: 1; transform: translate(-50%, -50%); }
}

@keyframes flip {
  0% {
    transform: rotate(0deg);
  }
  50% {
    transform: rotate(180deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

.paragraph-card {
  background: white;
  border-radius: 10px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  margin-bottom: 20px;
  overflow: hidden;
  transition: all 0.3s ease;
}

.paragraph-card:hover {
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.paragraph-header {
  background: #f8f9fa;
  padding: 15px;
  border-bottom: 1px solid #dee2e6;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.paragraph-body {
  padding: 20px;
  line-height: 1.6;
}

#output {
  margin-top: 20px;
  padding: 20px;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

@media (max-width: 768px) {
  .generator-container {
    padding: 10px;
  }
  
  .btn {
    width: 100%;
    margin: 5px 0;
  }
}

/* 心智圖樣式 */
.mindmap-container {
  margin: 20px 0;
  padding: 20px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  width: 100%;
  overflow: hidden;
  display: flex;  /* 添加flex布局 */
  justify-content: center;  /* 水平居中 */
  align-items: center;  /* 垂直居中 */
}

.mindmap-layout {
  display: grid;
  grid-template-columns: minmax(300px, 45%) minmax(400px, 55%);
  gap: 20px;
  width: 100%;
  margin-bottom: 20px;
}

.mindmap-editor-panel {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  height: fit-content;
}

.mindmap-preview-panel {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  height: fit-content;
  width: 100%;  /* 修改寬度為100% */
  overflow: hidden;  /* 添加overflow控制 */
}

#mindmap-editor {
  height: 400px;
  border: 1px solid #ddd;
  border-radius: 4px;
  width: 100%;
  margin-bottom: 10px;
}

#mindmap-content {
  min-height: 400px;
  width: 100%;
  background: #f8f9fa;
  border-radius: 4px;
  padding: 20px;
  overflow: auto;
  display: flex;
  justify-content: center;
  align-items: center;
  box-sizing: border-box;  /* 确保padding不影响宽度 */
}

/* 響應式設計 */
@media (max-width: 1024px) {
  .mindmap-layout {
    grid-template-columns: 1fr;
  }
  
  #mindmap-editor,
  #mindmap-content {
    height: 300px;
    min-height: 300px;
  }
}

/* 智能圖片插入樣式 */
.suggested-image {
  margin: 15px 0;
  padding: 10px;
  background: #f8f9fa;
  border-radius: 8px;
  text-align: center;
}

.suggested-image img {
  max-width: 100%;
  height: auto;
  border-radius: 4px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.image-caption {
  margin-top: 10px;
  font-size: 14px;
  color: #666;
  font-style: italic;
}

/* 動畫效果 */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.paragraph-card {
  animation: fadeIn 0.3s ease;
}

/* 心智圖編輯器樣式 */
.mindmap-editor-container {
  margin: 20px 0;
  padding: 20px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.editor-wrapper {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin: 20px 0;
}

.preview-wrapper {
  padding: 20px;
  background: #f8f9fa;
  border-radius: 8px;
  min-height: 300px;
}

#mindmap-editor {
  font-family: 'Consolas', monospace;
  font-size: 14px;
}

.preview-wrapper h4 {
  margin-bottom: 15px;
  color: #495057;
}

/* 添加心智圖相關樣式 */
.mindmap-modal {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.8);
}

.mindmap-modal-content {
  background-color: #fefefe;
  margin: 5% auto;
  padding: 20px;
  border: 1px solid #888;
  width: 90%;
  max-width: 1200px;
  border-radius: 8px;
  position: relative;
}

.mindmap-close {
  position: absolute;
  right: 15px;
  top: 10px;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}

.mindmap-close:hover {
  color: #666;
}

.mindmap-container {
  overflow: auto;
  max-height: 80vh;
}

.mindmap-container svg {
  cursor: zoom-in;
  transition: transform 0.3s ease;
}

.mindmap-container.zoomed {
  cursor: zoom-out;
}

.mindmap-container.zoomed svg {
  transform: scale(1.5);
  transform-origin: center center;
}

.mindmap-editor-container {
  margin-bottom: 20px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  padding: 20px;
}

.mindmap-toggle-btn {
  background-color: #007bff;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  margin-bottom: 10px;
}

.mindmap-toggle-btn:hover {
  background-color: #0056b3;
}

/* 修改生成結果區塊樣式 */
.paragraph-card {
  background: white;
  border-radius: 10px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  margin-bottom: 20px;
  overflow: hidden;
}

.paragraph-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
  background: #f8f9fa;
  border-bottom: 1px solid #dee2e6;
}

.paragraph-tools {
  display: flex;
  gap: 10px;
}

.paragraph-body {
  padding: 20px;
  line-height: 1.6;
}

.result-section {
  margin-top: 30px;
}

/* 心智圖容器樣式 */
.mindmap-container {
  margin: 20px 0;
  padding: 20px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  min-height: 200px;
}

.mindmap-container pre.mermaid {
  text-align: center;
  margin: 0;
  min-height: 200px;
}

/* 確保 SVG 圖表正確顯示 */
.mindmap-container svg {
  width: 100% !important;
  height: auto !important;
  min-height: 200px;
}

/* 添加調試用的邊框 */
#mindmap-content {
  border: 1px dashed #ccc;
  min-height: 200px;
  margin: 10px 0;
}

.result-layout {
  display: flex;
  flex-direction: column;
  gap: 20px;
  width: 100%;
}

.mindmap-panel {
  display: flex;
  flex-direction: column;
  gap: 20px;
  width: 100%;
}

.mindmap-editor-panel {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  height: fit-content;
  width: 90%;
}

.mindmap-preview-panel {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  height: fit-content;
  width: 110%;
}

#mindmap-editor {
  height: 400px;
  border: 1px solid #ddd;
  border-radius: 4px;
  width: 100%;
  margin-bottom: 10px;
}

#mindmap-content {
  min-height: 400px;
  width: 80%;
  background: #f8f9fa;
  border-radius: 4px;
  padding: 20px;
  overflow: auto;
}

.update-mindmap-btn {
  margin-top: 10px;
}

.mindmap-container {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.mindmap-container h4 {
  margin: 0;
  padding: 10px 0;
  color: #495057;
}

#mindmap-content {
  min-height: 300px;
  display: flex;
  justify-content: center;
  align-items: center;
  background: #f8f9fa;
  border-radius: 4px;
  padding: 15px;
  width: 80%;
}

#mindmap-content .mermaid {
  width: auto;  /* 允许自动调整宽度 */
  height: 400px;
  display: flex;
  justify-content: center;
  align-items: center;
}

#mindmap-content svg {
  max-width: 100%;
  height: auto;
  min-height: 200px;
}

.paragraph-card {
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  margin-bottom: 20px;
  overflow: hidden;
}

.paragraph-header {
  background: #f8f9fa;
  padding: 15px;
  border-bottom: 1px solid #dee2e6;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.paragraph-body {
  padding: 20px;
  line-height: 1.6;
}

#download-docx {
  margin-top: 20px;
  align-self: flex-end;
}

/* 提示框樣式 */
.save-toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 10px 20px;
  border-radius: 4px;
  z-index: 1000;
  animation: fadeInOut 2s ease;
}

.save-toast.error {
  background: rgba(220, 53, 69, 0.9);
}

@keyframes fadeInOut {
  0% { opacity: 0; transform: translateY(20px); }
  10% { opacity: 1; transform: translateY(0); }
  90% { opacity: 1; transform: translateY(0); }
  100% { opacity: 0; transform: translateY(-20px); }
}

/* 響應式設計 */
@media (min-width: 1024px) {
  .result-layout {
    grid-template-columns: 45% 55%;
  }
  
  .mindmap-panel {
    position: sticky;
    top: 20px;
    height: fit-content;
  }
}

/* 確保心智圖節點文字可以顯示中文 */
.mindmap-container .mindmap-node text {
  color: black;
  font-family: "Microsoft JhengHei", "微軟正黑體", "Arial", sans-serif !important;
  font-size: 14px !important;
}

.mindmap-container .mindmap-node > g > circle,
.mindmap-container .mindmap-node > g > rect {
  color: black;
  fill: #f8f9fa !important;
  stroke: #007bff !important;
  stroke-width: 2px !important;
}

.mindmap-container .mindmap-node.root > g > circle {
  fill: #007bff !important;
}

.mindmap-container .mindmap-node.root > g > text {
  color: black;
  fill: black !important;  /* 修改中心節點文字顏色為黑色 */
  font-weight: bold !important;  /* 加粗中心節點文字 */
}

.quota-info {
  background: #f8f9fa;
  border-left: 4px solid #007bff;
  padding: 10px 15px;
  margin-bottom: 20px;
  border-radius: 4px;
  font-size: 14px;
}

.quota-info p {
  margin: 0;
  color: #495057;
}

.result-layout {
  display: flex;
  flex-direction: column;
  gap: 20px;
  width: 100%;
}

.mindmap-panel {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.mindmap-editor-panel {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.mindmap-preview-panel {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#mindmap-editor {
  height: 300px;
  border: 1px solid #ddd;
  border-radius: 4px;
  width: 100%;
  margin-bottom: 10px;
}

#mindmap-content {
  min-height: 300px;
  width: 100%;
  background: #f8f9fa;
  border-radius: 4px;
  padding: 20px;
  overflow: auto;
}

.update-mindmap-btn {
  width: 100%;
  margin-top: 10px;
}

/* 响应式布局 */
@media (min-width: 1200px) {
  .result-layout {
    grid-template-columns: minmax(400px, 45%) 1fr;
  }
  
  .mindmap-panel {
    position: sticky;
    top: 20px;
  }
}

/* 确保心智图内容正确显示 */
.mermaid {
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
}

.mermaid svg {
  max-width: 100%;
  height: auto !important;
  min-height: 200px;
}

.output-section {
  width: 100%;
  margin-top: 20px;
}

.alert {
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
}

.alert-danger {
  background-color: #fff2f0;
  border: 1px solid #ffccc7;
  color: #cf1322;
}

.alert-danger h5 {
  color: #cf1322;
  margin-top: 0;
  margin-bottom: 10px;
}

.alert-danger small {
  color: #ff7875;
  display: block;
  margin-top: 10px;
}

#mindmap-content .mermaid {
  max-width: 100%;  /* 确保不超出容器 */
  height: auto;
  display: flex;
  justify-content: center;
  align-items: center;
}
</style>

<!-- 添加心智圖模態框 -->
<div id="mindmapModal" class="mindmap-modal">
  <div class="mindmap-modal-content">
    <span class="mindmap-close">&times;</span>
    <h3>心智圖預覽</h3>
    <div id="modalMindmapPreview" class="mindmap-container"></div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  let schoolData = {};

  // 載入學校列表
  async function loadUniversities() {
    try {
      const response = await fetch("/get_universities");
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const data = await response.json();
      
      $("#university").empty().append('<option value="">請選擇學校</option>');
      data.forEach((uni) => {
        $("#university").append(`<option value="${uni}">${uni}</option>`);
      });
      
      // 如果有預選的學校，設置選中狀態
      const preSelectedUniversity = "{{ university }}";
      if (preSelectedUniversity) {
        $("#university").val(preSelectedUniversity);
        await loadDepartments(preSelectedUniversity);
      }
    } catch (error) {
      console.error('載入學校清單失敗:', error);
      alert("載入學校清單失敗，請重試");
    }
  }

  function loadDepartments(university) {
    if (!university) {
      $("#department").empty().append('<option value="">請先選擇學校</option>');
      return;
    }

    $.get(`/get_departments?university=${encodeURIComponent(university)}`, function (departments) {
      $("#department").empty().append('<option value="">請選擇學系</option>');
      departments.forEach((dept) => {
        $("#department").append(`<option value="${dept}">${dept}</option>`);
      });
      
      // 如果有預選的學系，設置選中狀態
      const preSelectedDepartment = "{{ department }}";
      if (preSelectedDepartment) {
        $("#department").val(preSelectedDepartment);
        // 如果有預選的學校和學系，自動載入指引
        if (university === "{{ university }}") {
          loadGuidelines();
        }
      }
    });
  }

  // 確認學系後載入該學系的備審資料
  function loadGuidelines() {
    return new Promise((resolve, reject) => {
      let university = $("#university").val();
      let department = $("#department").val();

      if (!university || !department) {
        alert("請選擇學校與學系！");
        reject();
        return;
      }

      $.ajax({
        url: "/get_guidelines",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ university, department }),
        dataType: "json",
        success: function (data) {
          if (!data.sections) {
            alert("該學系目前沒有備審資料！");
            reject();
            return;
          }

          // 設置全局變量
          window.departmentInfo = data;

          // 重置段落選擇
          $("#section_code").val("");
          
          // 更新輸入欄位
          updateFieldsBasedOnSelection();
          
          resolve();
        },
        error: function () {
          alert("載入備審資料失敗，請檢查學校與學系是否正確！");
          reject();
        },
      });
    });
  }

  // 更新可輸入的欄位
  function updateFieldsBasedOnSelection() {
      const sectionCode = document.getElementById('section_code').value;
      const fieldsContainer = document.getElementById('fields');
      
      fieldsContainer.innerHTML = ''; // 清空現有的輸入框
  
      if (!sectionCode) return;
  
      const codes = SECTION_MAPPING[sectionCode];
      if (!codes) return;
 
      // 獲取學系要求的備審項目
      const sections = window.departmentInfo?.sections || {};
 
      // 創建標題
      const titleDiv = document.createElement('div');
      titleDiv.className = 'input-section';
      titleDiv.innerHTML = `
          <h4 class="section-title">📌 請於以下各項目輸入至多300字之簡述內容</h4>
          <p class="text-muted">系統將根據您的輸入內容，生成完整的備審資料段落</p>
          <p class="text-muted">${codes.prompt}</p>
      `;
      fieldsContainer.appendChild(titleDiv);
  
      // 為每個代碼創建輸入區域
      codes.codes.forEach(code => {
          // 檢查該代碼是否在學系要求中
          if (!sections[code]) return;
 
          const sectionDiv = document.createElement('div');
          sectionDiv.className = 'input-section';
          
          const titleDiv = document.createElement('div');
          titleDiv.className = 'section-title';
          titleDiv.innerHTML = `
              <h4>${code} - ${CODE_MAPPING[code]}</h4>
              <p class="text-muted">${sections[code].content || '無特殊說明'}</p>
          `;
          
          // 創建文字輸入區域
          const textareaDiv = document.createElement('div');
          textareaDiv.className = 'textarea-container';
          
          const textarea = document.createElement('textarea');
          textarea.className = 'form-control';
          textarea.id = `input_${code}`;
          textarea.placeholder = `請輸入${CODE_MAPPING[code]}相關內容...`;
          textarea.maxLength = 300;
          
          // 創建字數計數器
          const charCount = document.createElement('div');
          charCount.className = 'char-count';
          charCount.id = `charCount_${code}`;
          charCount.textContent = '0/300 字';
          
          // 創建上傳按鈕和預覽區域
          const uploadContainer = document.createElement('div');
          uploadContainer.className = 'upload-container';
          uploadContainer.innerHTML = `
              <div class="upload-instructions">
                  <p>📎 可上傳圖片或PDF檔案，系統會自動辨識文字</p>
                  <small class="text-muted">支援格式：JPG、PNG、PDF</small>
              </div>
              <div class="upload-buttons">
                  <input type="file" id="file_${code}" class="form-control" 
                         accept=".jpg,.jpeg,.png,.pdf" 
                         onchange="handleFileUpload(this, '${code}')" 
                         style="display: none;">
                  <button class="btn btn-outline-primary" onclick="document.getElementById('file_${code}').click()">
                      <i class="fas fa-upload"></i> 上傳檔案
                  </button>
                  <button class="btn btn-outline-danger" onclick="clearUpload('${code}')" 
                          style="display: none;" id="clear_${code}">
                      <i class="fas fa-times"></i> 清除
                  </button>
              </div>
              <div id="preview_${code}" class="preview-area"></div>
          `;
          
          // 組裝所有元素
          textareaDiv.appendChild(textarea);
          textareaDiv.appendChild(charCount);
          sectionDiv.appendChild(titleDiv);
          sectionDiv.appendChild(textareaDiv);
          sectionDiv.appendChild(uploadContainer);
          fieldsContainer.appendChild(sectionDiv);
          
          // 添加字數計數監聽器
          const currentTextarea = document.getElementById(`input_${code}`);
          const currentCharCount = document.getElementById(`charCount_${code}`);
          currentTextarea.addEventListener('input', function() {
              const count = this.value.length;
              currentCharCount.textContent = `${count}/300 字`;
          });
      });
 
      // 如果沒有生成任何輸入框，顯示提示訊息
      if (fieldsContainer.children.length === 1) { // 只有標題
          const noFieldsMsg = document.createElement('div');
          noFieldsMsg.className = 'alert alert-info';
          noFieldsMsg.innerHTML = '此學系不需要填寫所選擇的段落類型。';
          fieldsContainer.appendChild(noFieldsMsg);
      }
    }
 
    // 添加樣式
    const style = document.createElement('style');
    style.textContent = `
        .input-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section-title {
            margin-bottom: 15px;
        }
        .section-title h4 {
            color: #2c3e50;
            margin-bottom: 5px;
        }
        .textarea-container {
            margin-bottom: 15px;
        }
        .char-count {
            text-align: right;
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .upload-container {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }
        .upload-instructions {
            margin-bottom: 15px;
        }
        .upload-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .preview-area {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
    `;
    document.head.appendChild(style);
 
    // ... 其他現有的代碼 ...

  // 顯示 loading
  function showLoading(message = "處理中...") {
    $("body").addClass("loading");
    const useHourglass = message.includes("處理文件") || message.includes("生成內容");
    $("#loading-spinner").html(`
      ${useHourglass ? `
      <svg class="hourglass-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 2H2v6h20V2zM22 16H2v6h20v-6zM12 2v20M7 2s2.5 6 5 6 5-6 5-6M7 22s2.5-6 5-6 5 6 5 6"></path>
      </svg>
      ` : `
      <svg class="loading-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path>
      </svg>
      `}
      <span class="loading-text">${message}</span>
    `);
    $("#loading-overlay").css('display', 'flex').fadeIn(300);
  }

  // 隱藏 loading
  function hideLoading() {
    $("#loading-overlay").fadeOut(300, function() {
      $("body").removeClass("loading");
    });
  }

  // 修改渲染心智圖的函數
  function renderMindmap(code) {
    console.log('開始渲染心智圖，代碼長度:', code.length);
    
    if (!code || typeof code !== 'string') {
      console.error('無效的心智圖代碼');
      return;
    }

    // 初始化編輯器（如果還沒有初始化）
    if (!window.mindmapEditor) {
      require(['vs/editor/editor.main'], function() {
        window.mindmapEditor = monaco.editor.create(document.getElementById('mindmap-editor'), {
          value: code,
          language: 'markdown',
          theme: 'vs-light',
          minimap: { enabled: false },
          lineNumbers: 'on',
          scrollBeyondLastLine: false,
          automaticLayout: true,
          fontSize: 14
        });

        // 添加實時預覽
        let previewTimeout;
        window.mindmapEditor.onDidChangeModelContent(() => {
          clearTimeout(previewTimeout);
          previewTimeout = setTimeout(() => {
            const newCode = window.mindmapEditor.getValue();
            updateMindmapPreview(newCode);
          }, 300);
        });
      });
    } else {
      window.mindmapEditor.setValue(code);
    }

    // 更新預覽
    updateMindmapPreview(code);
  }

  function updateMindmapPreview(code) {
    const container = document.getElementById('mindmap-content');
    if (!container) {
      console.error('找不到 mindmap-content 容器');
      return;
    }

    // 確保代碼以 "mindmap" 開頭
    let processedCode = code.trim();
    if (!processedCode.startsWith('mindmap')) {
      processedCode = 'mindmap\n' + processedCode;
    }

    // 清空容器
    container.innerHTML = '';
    
    // 創建新的 mermaid 元素
    const mermaidDiv = document.createElement('div');
    mermaidDiv.className = 'mermaid';
    mermaidDiv.textContent = processedCode;
    container.appendChild(mermaidDiv);

    // 重新初始化 mermaid
    try {
      mermaid.initialize({
        startOnLoad: false,
        theme: 'default',
        securityLevel: 'loose',
        mindmap: {
          padding: 20,
          useMaxWidth: true
        }
      });

      // 使用 Promise 處理渲染
      mermaid.init(undefined, '.mermaid')
        .then(() => {
          console.log('心智圖預覽更新成功');
          const svg = container.querySelector('svg');
          if (svg) {
            svg.style.width = '100%';
            svg.style.height = 'auto';
            svg.style.minHeight = '200px';
          }
        })
        .catch(err => {
          console.error('心智圖預覽更新失敗:', err);
          container.innerHTML = '<div class="error-message">心智圖預覽生成失敗，請檢查語法是否正確</div>';
        });
    } catch (err) {
      console.error('Mermaid 初始化失敗:', err);
      container.innerHTML = '<div class="error-message">心智圖預覽初始化失敗</div>';
    }
  }

  function updateMindmap() {
    const newCode = window.mindmapEditor.getValue();
    
    // 更新預覽
    updateMindmapPreview(newCode);
    
    // 更新全局數據中的心智圖
    if (window.generatedDocxData) {
      window.generatedDocxData.mindmap_data = {
        mindmap_svg: newCode
      };
      // 重新啟用保存功能
      saveGeneratedContent(window.generatedDocxData);
    }
  }

  // 保存生成的內容
  function saveGeneratedContent(data) {
    if (!data) {
      console.error('無效的生成數據');
      return;
    }

    // 檢查必要欄位
    if (!data.university || !data.department || !data.section_code || !data.generated_text) {
      console.error('缺少必要欄位');
      return;
    }

    // 構建請求數據
    const requestData = {
      university: data.university,
      department: data.department,
      section_code: data.section_code,
      generated_text: data.generated_text,
      mindmap_data: data.mindmap_data || null,
      style: data.style || 'formal'
    };

    console.log('正在保存生成內容:', requestData);

    $.ajax({
      url: "/save_generated_content",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify(requestData),
      success: function(response) {
        if (response.success) {
          console.log("內容已保存，history_id:", response.history_id);
          
          // 更新URL，但不重新加載頁面
          if (response.history_id) {
            const newUrl = new URL(window.location.href);
            newUrl.searchParams.set('history_id', response.history_id);
            window.history.pushState({}, '', newUrl);

            // 顯示成功提示
            showSuccessToast('✅ 更改已保存');
          }
        } else {
          console.error("保存失敗:", response.error);
          showErrorToast(response.error || "保存失敗，請重試");
        }
      },
      error: function(xhr, status, error) {
        console.error("保存失敗:", error);
        console.error("詳細錯誤:", xhr.responseText);
        showErrorToast("保存失敗，請重試");
      }
    });
  }

  function showSuccessToast(message) {
    const toast = document.createElement('div');
    toast.className = 'save-toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.remove();
    }, 2000);
  }

  function showErrorToast(message) {
    const toast = document.createElement('div');
    toast.className = 'save-toast error';
    toast.textContent = `❌ ${message}`;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.remove();
    }, 2000);
  }

  // 修改生成段落的函數
  function generateParagraph() {
    let university = $("#university").val();
    let department = $("#department").val();
    let sectionCode = $("#section_code").val();
    let style = $("#style").val();
    let userInputs = {};

    if (!sectionCode) {
      alert("請選擇要生成的段落");
      return;
    }

    let hasInput = false;
    $("textarea").each(function () {
      let code = this.id.replace("input_", "");
      let value = $(this).val();
      if (value !== undefined && value.trim() !== "") {
        userInputs[code] = value.trim();
        hasInput = true;
      }
    });

    if (!hasInput) {
      alert("請至少填寫一個輸入框後再生成段落！");
      return;
    }

    // 清空之前的生成結果
    $("#output").empty();
    
    showLoading("🤖 正在生成內容，請稍候...");

    // 先生成心智圖
    $.ajax({
      url: "/generate_mindmap",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify({
        university,
        department,
        section_code: sectionCode,
        user_inputs: userInputs
      }),
      success: function(mindmapData) {
        console.log("心智圖生成成功:", mindmapData);
        
        // 檢查並提取心智圖代碼
        let mindmapCode = null;
        if (typeof mindmapData === 'object') {
          if (mindmapData.mindmap_svg) {
            mindmapCode = mindmapData.mindmap_svg;
          } else if (mindmapData.mindmap_code) {
            mindmapCode = mindmapData.mindmap_code;
          }
        }

        // 如果找到有效的心智圖代碼，進行渲染
        if (mindmapCode && typeof mindmapCode === 'string') {
          console.log("開始渲染心智圖");
          renderMindmap(mindmapCode.trim());
        } else {
          console.error("無效的心智圖數據格式");
        }
        
        // 繼續生成段落
        generateParagraphContent(mindmapData);
      },
      error: function(xhr, status, error) {
        console.error("生成心智圖錯誤:", error);
        hideLoading();
        alert("生成心智圖時發生錯誤，請重試");
      }
    });
  }

  // 修改段落生成函數
  function generateParagraphContent(mindmapData) {
    console.log("開始生成段落內容");
    let university = $("#university").val();
    let department = $("#department").val();
    let sectionCode = $("#section_code").val();
    let style = $("#style").val();
    let userInputs = {};

    $("textarea").each(function () {
      let code = this.id.replace("input_", "");
      let value = $(this).val();
      if (value !== undefined && value.trim() !== "") {
        userInputs[code] = value.trim();
      }
    });

    // 構建請求數據
    const requestData = {
      university,
      department,
      section_code: sectionCode,
      user_inputs: userInputs,
      style,
      mindmap_data: mindmapData
    };

    console.log("發送生成段落請求:", requestData);

    $.ajax({
      url: "/generate_paragraph",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify(requestData),
      success: function(data) {
        console.log("段落生成成功:", data);
        hideLoading();

        if (!data || !data.generated_text) {
          console.error("生成的數據格式無效");
          alert("生成的內容格式無效，請重試");
          return;
        }

        // 顯示生成的段落
        const blocks = data.generated_text.split(/\n{2,}/);
        blocks.forEach((block, idx) => {
          const trimmed = block.trim();
          if (!trimmed) return;

          const isTable = trimmed.includes("<table");
          let contentHtml = isTable
            ? trimmed
            : `<p>${trimmed.replace(/\n/g, "<br>")}</p>`;

          $("#output").append(`
            <div class="paragraph-card" id="paragraph-${idx}">
              <div class="paragraph-header">
                <span>📄 段落 ${idx + 1}</span>
                ${!isTable ? 
                  `<button class="btn btn-outline-primary btn-sm" onclick="regenerateParagraph(${idx})">
                    🔄 重新生成
                  </button>` : 
                  ''}
              </div>
              <div class="paragraph-body">
                ${contentHtml}
              </div>
            </div>
          `);
        });

        // 保存生成結果到全局變量
        window.generatedDocxData = {
          university,
          department,
          section_code: sectionCode,
          generated_text: data.generated_text,
          mindmap_data: mindmapData,
          style: style
        };

        // 保存到歷史記錄
        saveGeneratedContent(window.generatedDocxData);

        $("#download-docx").show();
      },
      error: function(xhr, status, error) {
        hideLoading();
        console.error("生成段落錯誤:", error);
        console.error("HTTP 狀態:", xhr.status);
        console.error("錯誤詳情:", xhr.responseText);

        let errorMessage = "生成段落時發生錯誤";
        
        try {
          // 嘗試解析錯誤響應
          const errorResponse = JSON.parse(xhr.responseText);
          if (errorResponse.error) {
            errorMessage = errorResponse.error;
          }
        } catch (e) {
          // 如果無法解析 JSON，使用原始錯誤文本
          if (xhr.responseText) {
            errorMessage = xhr.responseText;
          }
        }

        // 顯示錯誤提示
        const errorHtml = `
          <div class="alert alert-danger">
            <h5>❌ 生成失敗</h5>
            <p>${errorMessage}</p>
            <small>請稍後重試或聯繫管理員</small>
          </div>
        `;
        
        $("#output").html(errorHtml);
      }
    });
  }

  function regenerateParagraph(index) {
    const paraCard = document.querySelector(
      `#paragraph-${index} .paragraph-body`
    );
    const style = $("#style").val() || "formal";
    const title = paraCard.querySelector("h4")?.innerText || "";
    const body = paraCard.querySelector("p")?.innerText || "";

    // 暫時顯示 loading spinner
    paraCard.innerHTML = `
    <div style="text-align:center; padding:20px;">
      ⏳ 段落重新生成中...
    </div>
  `;

    $.ajax({
      url: "/regenerate_paragraph",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify({
        original_paragraph: `${title}\n${body}`,
        style: style,
      }),
      success: function (data) {
        const [newTitle, ...newRest] = data.new_paragraph.trim().split("\n");
        const newBody = newRest.join("\n");
        paraCard.innerHTML = `
        <h4>${newTitle}</h4>
        <p>${newBody}</p>
      `;
      },
      error: function (xhr, status, error) {
        paraCard.innerHTML = `<p style="color:red;">❌ 生成失敗，請重試</p>`;
      },
    });
  }

  function downloadDocx() {
    if (!window.generatedDocxData) {
      alert("請先生成內容！");
      return;
    }

    $.ajax({
      url: "/generate_docx",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify(window.generatedDocxData),
      xhrFields: {
        responseType: "blob",
      },
      success: function (blob) {
        let link = document.createElement("a");
        link.href = window.URL.createObjectURL(blob);

        let filename = `${window.generatedDocxData.university}${window.generatedDocxData.department}_${window.generatedDocxData.section_code}.docx`;

        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      },
      error: function () {
        alert("下載失敗，請重試！");
      },
    });
  }

  // 處理多文件上傳
  function handleFiles(files, code) {
    const previewArea = document.getElementById(`preview_${code}`);
    const processButton = previewArea.nextElementSibling;
    
    // 清空預覽區
    if (!previewArea.hasChildNodes()) {
        previewArea.innerHTML = '';
    }

    // 處理每個文件
    files.forEach(file => {
        const reader = new FileReader();
        const previewItem = document.createElement('div');
        previewItem.className = 'preview-item';
        
        // 創建刪除按鈕
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.innerHTML = '×';
        removeBtn.onclick = () => {
            previewItem.remove();
            if (!previewArea.hasChildNodes()) {
                processButton.style.display = 'none';
            }
        };

        if (file.type.startsWith('image/')) {
            reader.onload = (e) => {
                previewItem.innerHTML = `
                    <img src="${e.target.result}" alt="preview">
                `;
                previewItem.appendChild(removeBtn);
            };
            reader.readAsDataURL(file);
        } else if (file.type === 'application/pdf') {
            previewItem.innerHTML = `
                <div style="background: #f8f9fa; height: 100%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-file-pdf" style="font-size: 40px; color: #dc3545;"></i>
                </div>
            `;
            previewItem.appendChild(removeBtn);
        }

        previewArea.appendChild(previewItem);
    });

    // 顯示處理按鈕
    processButton.style.display = 'block';
  }

  // 處理多個文件
  async function processFiles(code) {
    const fileInput = document.getElementById(`files_${code}`);
    const textarea = document.getElementById(`input_${code}`);
    
    if (!fileInput.files || fileInput.files.length === 0) {
        alert("請先選擇要處理的檔案！");
        return;
    }

    // 顯示載入中
    $("#loading-overlay").fadeIn();
    $("#loading-spinner").html(`
      <svg class="hourglass-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 2H2v6h20V2zM22 16H2v6h20v-6zM12 2v20M7 2s2.5 6 5 6 5-6 5-6M7 22s2.5-6 5-6 5 6 5 6"></path>
      </svg>
      <span class="loading-text">⏳ 正在處理文件...</span>
    `);

    try {
        let allText = '';
        const MAX_TOTAL_LENGTH = 300;

        for (let file of fileInput.files) {
            let singleFormData = new FormData();
            singleFormData.append('file', file);
            singleFormData.append('code', code);

            const response = await fetch('/process_ocr', {
                method: 'POST',
                body: singleFormData
            });

            const result = await response.json();
            if (result.success) {
                let processedText = `【${file.name}】\n${result.text}\n\n`;
                
                // 如果內容被濃縮了，添加提示
                if (result.was_condensed) {
                    processedText = `【${file.name}】(已自動濃縮)\n${result.text}\n\n`;
                }
                
                // 檢查總字數
                if ((allText.length + processedText.length) > MAX_TOTAL_LENGTH) {
                    // 如果已經有內容，進行整體濃縮
                    if (allText) {
                        const response = await fetch('/condense_text', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                text: allText + processedText,
                                max_length: MAX_TOTAL_LENGTH
                            })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            allText = result.text + "\n\n(內容已自動濃縮至300字)";
                        }
                    }
                    break;
                }
                
                allText += processedText;
            }
        }

        if (allText) {
            textarea.value = allText.trim();
            updateCharCount(textarea);
        } else {
            alert("無法處理文件，請重試");
        }
    } catch (error) {
        console.error('處理文件時發生錯誤:', error);
        alert("處理文件時發生錯誤，請重試");
    } finally {
        $("#loading-overlay").fadeOut();
        $("#loading-spinner").text("⏳ 內容生成中，請稍候...");
    }
  }

  // 綁定事件
  $(document).ready(function () {
    // 檢查配額並初始化頁面
    checkQuota().then(function(response) {
        if (response.error) {
            alert(response.error);
            return;
        }
        
        $("#quota-check-wrapper").show();
        loadUniversities();
        
        // 監聽學校選擇變化
        $("#university").change(async function() {
            await loadDepartments($(this).val());
        });
    });
  });

  // 修改載入歷史記錄的函數
  async function loadHistoryContent(historyId) {
    try {
      showLoading("載入歷史記錄中...");
      
      // 1. 先載入歷史記錄數據
      const historyResponse = await $.get(`/load_history?history_id=${historyId}`);
      
      if (!historyResponse || !historyResponse.university || !historyResponse.department) {
        throw new Error('歷史記錄數據不完整');
      }

      // 2. 載入學校列表並選擇對應學校
      const universities = await $.get("/get_universities");
      $("#university").empty().append('<option value="">請選擇學校</option>');
      universities.forEach((uni) => {
        $("#university").append(`<option value="${uni}">${uni}</option>`);
      });
      $("#university").val(historyResponse.university);

      // 3. 載入該學校的科系列表並選擇對應科系
      const departments = await $.get(`/get_departments?university=${encodeURIComponent(historyResponse.university)}`);
      $("#department").empty().append('<option value="">請選擇學系</option>');
      departments.forEach((dept) => {
        $("#department").append(`<option value="${dept}">${dept}</option>`);
      });
      $("#department").val(historyResponse.department);

      // 4. 載入備審指引
      const guidelinesResponse = await $.ajax({
        url: "/get_guidelines",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({
          university: historyResponse.university,
          department: historyResponse.department
        })
      });

      if (!guidelinesResponse.sections) {
        throw new Error('無法載入備審指引');
      }

      // 5. 儲存備審指引到 sessionStorage
      sessionStorage.setItem(
        `${historyResponse.university}_${historyResponse.department}_sections`,
        JSON.stringify(guidelinesResponse.sections)
      );

      // 6. 設置段落代碼和風格
      $("#section_code").val(historyResponse.section_code);
      $("#style").val(historyResponse.style || 'formal');
      
      // 7. 更新輸入欄位
      updateFieldsBasedOnSelection();
      
      // 8. 等待輸入欄位生成完成
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // 9. 填入使用者輸入（如果有）
      try {
        if (historyResponse.user_inputs && Object.keys(historyResponse.user_inputs).length > 0) {
          Object.entries(historyResponse.user_inputs).forEach(([code, value]) => {
            const inputField = document.getElementById(`input_${code}`);
            if (inputField) {
              inputField.value = value;
              updateCharCount(inputField);
            }
          });
        }
      } catch (error) {
        console.warn('無法載入使用者輸入:', error);
      }
      
      // 10. 顯示生成結果
      if (historyResponse.generated_text) {
        displayHistoryContent(historyResponse);
      }
      
      // 11. 如果有心智圖數據，載入並渲染
      if (historyResponse.mindmap_data) {
        const mindmapCode = historyResponse.mindmap_data.mindmap_svg || historyResponse.mindmap_data.mindmap_code;
        if (mindmapCode) {
          renderMindmap(mindmapCode.trim());
        }
      }
      
      // 12. 更新全局數據
      window.generatedDocxData = {
        university: historyResponse.university,
        department: historyResponse.department,
        section_code: historyResponse.section_code,
        generated_text: historyResponse.generated_text,
        mindmap_data: historyResponse.mindmap_data,
        style: historyResponse.style
      };
      
      hideLoading();
      showSuccessToast('✅ 歷史記錄載入成功');
      
    } catch (error) {
      console.error('載入歷史記錄時發生錯誤:', error);
      hideLoading();
      showErrorToast('載入失敗：' + (error.message || '請稍後再試'));
      
      // 如果載入失敗，等待 2 秒後重定向回會員中心
      setTimeout(() => {
        window.location.href = '/profile';
      }, 2000);
    }
  }

  // 初始化 Monaco Editor
  require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
  require(['vs/editor/editor.main'], function() {
    window.mindmapEditor = monaco.editor.create(document.getElementById('mindmap-editor'), {
      value: 'mindmap\n  root((主題))\n    branch1[分支1]\n      sub1[子項目1]\n      sub2[子項目2]\n    branch2[分支2]\n      sub3[子項目3]',
      language: 'markdown',
      theme: 'vs-light',
      minimap: { enabled: false },
      lineNumbers: 'on',
      scrollBeyondLastLine: false,
      automaticLayout: true
    });
  });

  // 修改載入歷史記錄的顯示方式
  function displayHistoryContent(historyResponse) {
    // 清空之前的內容
    $("#output").empty();
    $("#mindmap-content").empty();
    $("#mindmap-container").hide();
    
    // 如果有心智圖，顯示在頂部
    if (historyResponse.mindmap_data) {
      const mindmapCode = historyResponse.mindmap_data.mindmap_svg || historyResponse.mindmap_data.mindmap_code;
      if (mindmapCode) {
        renderMindmap(mindmapCode);
      }
    }

    // 顯示生成的段落
    const blocks = historyResponse.generated_text.split(/\n{2,}/);
    blocks.forEach((block, idx) => {
      const trimmed = block.trim();
      if (!trimmed) return;

      const isTable = trimmed.includes("<table");
      let contentHtml = isTable
        ? trimmed
        : `<p>${trimmed.replace(/\n/g, "<br>")}</p>`;

      $("#output").append(`
        <div class="paragraph-card" id="paragraph-${idx}">
          <div class="paragraph-header">
            <span>📄 段落 ${idx + 1}</span>
            ${!isTable ? 
              `<button class="btn btn-outline-primary btn-sm" onclick="regenerateParagraph(${idx})">
                🔄 重新生成
              </button>` : 
              ''}
          </div>
          <div class="paragraph-body">
            ${contentHtml}
          </div>
        </div>
      `);
    });

    // 保存到全局變量
    window.generatedDocxData = {
      university: historyResponse.university,
      department: historyResponse.department,
      section_code: historyResponse.section_code,
      generated_text: historyResponse.generated_text,
      mindmap_data: historyResponse.mindmap_data,
      style: historyResponse.style
    };

    $("#download-docx").show();
  }

  // 添加事件監聽器
  document.addEventListener('DOMContentLoaded', function() {
    // 關閉心智圖模態框
    const modal = document.getElementById('mindmapModal');
    const closeBtn = document.querySelector('.mindmap-close');
    
    closeBtn.onclick = function() {
      modal.style.display = 'none';
    }
    
    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }
    
    // 心智圖縮放功能
    document.querySelectorAll('.mindmap-container').forEach(container => {
      container.addEventListener('click', function() {
        this.classList.toggle('zoomed');
      });
    });
  });

  // 添加調試函數
  function checkMindmapData() {
    const container = document.getElementById('mindmap-content');
    console.log('心智圖容器內容:', container.innerHTML);
    console.log('心智圖容器可見性:', $("#mindmap-container").is(":visible"));
    const mermaidElements = document.querySelectorAll('.mermaid');
    console.log('Mermaid 元素數量:', mermaidElements.length);
    mermaidElements.forEach((el, i) => {
      console.log(`Mermaid 元素 ${i} 內容:`, el.textContent);
    });
  }

  // 在生成完成後檢查
  $(document).ajaxComplete(function(event, xhr, settings) {
    if (settings.url === "/generate_mindmap") {
      setTimeout(checkMindmapData, 1000);
    }
  });

  // 添加全局錯誤處理
  window.addEventListener('error', function(event) {
    if (event.error && event.error.toString().includes('mermaid')) {
      console.error('Mermaid 錯誤:', event.error);
      // 防止錯誤中斷編輯器功能
      event.preventDefault();
    }
  });

  // 在頁面載入時執行
  document.addEventListener('DOMContentLoaded', async function() {
    try {
        // 檢查配額
        const quotaResponse = await fetch('/check_quota');
        const quotaData = await quotaResponse.json();
        
        if (quotaData.error) {
            alert(quotaData.error);
            return;
        }

        // 如果配額足夠或是無限方案，顯示生成器
        if (quotaData.remaining_quota > 0 || quotaData.remaining_quota === -1) {
            document.getElementById('quota-check-wrapper').style.display = 'block';
            
            // 檢查是否有預設的學校和學系（從 URL 參數獲取）
            const urlParams = new URLSearchParams(window.location.search);
            const preSelectedUniversity = urlParams.get('university');
            const preSelectedDepartment = urlParams.get('department');

            // 載入學校列表
            await loadUniversities(preSelectedUniversity, preSelectedDepartment);

            // 監聽學校選擇變化
            document.getElementById('university').addEventListener('change', async function() {
                await loadDepartments(this.value);
            });

            // 監聽學系選擇變化
            document.getElementById('department').addEventListener('change', function() {
                // 如果已經選擇了段落類型，重新載入輸入框
                const sectionCode = document.getElementById('section_code').value;
                if (sectionCode) {
                    updateFieldsBasedOnSelection();
                }
            });

            // 如果有預選的學校和學系，自動載入相關資訊
            if (preSelectedUniversity && preSelectedDepartment) {
                await loadGuidelines();
            }
        } else {
            alert('您的生成次數已用完，請升級方案以獲得更多次數。');
            window.location.href = '/profile';
        }
    } catch (error) {
        console.error('初始化錯誤:', error);
        alert('載入頁面時發生錯誤，請重新整理試試。');
    }
  });

  // 載入學校列表
  async function loadUniversities(preSelectedUniversity, preSelectedDepartment) {
    try {
        const response = await fetch('/get_universities');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        
        const universitySelect = document.getElementById('university');
        universitySelect.innerHTML = '<option value="">請選擇學校</option>';
        
        data.forEach(uni => {
            const option = document.createElement('option');
            option.value = uni;
            option.textContent = uni;
            if (uni === preSelectedUniversity) {
                option.selected = true;
            }
            universitySelect.appendChild(option);
        });

        // 如果有預選的學校，載入該學校的學系
        if (preSelectedUniversity) {
            await loadDepartments(preSelectedUniversity, preSelectedDepartment);
        }
    } catch (error) {
        console.error('載入學校列表失敗:', error);
        alert('載入學校列表失敗，請重新整理頁面試試。');
    }
  }

  let isLoadingDepartments = false;  // 添加標誌

  // 修改載入學系列表函數
  async function loadDepartments(university, preSelectedDepartment) {
    if (!university) {
      const departmentSelect = document.getElementById('department');
      departmentSelect.innerHTML = '<option value="">請先選擇學校</option>';
      return;
    }

    // 如果正在加載，則返回
    if (isLoadingDepartments) {
      return;
    }

    try {
      isLoadingDepartments = true;  // 設置加載標誌
      const response = await fetch(`/get_departments?university=${encodeURIComponent(university)}`);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const data = await response.json();
      
      const departmentSelect = document.getElementById('department');
      departmentSelect.innerHTML = '<option value="">請選擇學系</option>';
      
      data.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept;
        option.textContent = dept;
        if (dept === preSelectedDepartment) {
          option.selected = true;
        }
        departmentSelect.appendChild(option);
      });
    } catch (error) {
      console.error('載入學系列表失敗:', error);
      alert('載入學系列表失敗，請重新整理頁面試試。');
    } finally {
      isLoadingDepartments = false;  // 重置加載標誌
    }
  }

  // 載入學系指引
  async function loadGuidelines() {
    const university = document.getElementById('university').value;
    const department = document.getElementById('department').value;

    if (!university || !department) {
      showError('請選擇學校和學系');
      return;
    }

    try {
      const response = await fetch('/get_guidelines', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ university, department })
      });

      if (!response.ok) {
        throw new Error('載入學系指引失敗');
      }

      const data = await response.json();
      window.departmentInfo = data;  // 儲存學系資訊供後續使用

      // 更新欄位
      const sectionCode = document.getElementById('section_code').value;
      if (sectionCode) {
        updateFieldsBasedOnSelection();
      }

    } catch (error) {
      console.error('載入學系指引失敗:', error);
      showError('載入學系指引失敗，請重新整理頁面試試');
    }
  }

  // 顯示錯誤訊息
  function showError(message) {
    // 可以使用 Bootstrap 的 alert 或自定義的錯誤顯示方式
    alert(message);
  }

  // 當頁面載入完成時執行
  document.addEventListener('DOMContentLoaded', function() {
    // 檢查是否有 URL 參數
    const urlParams = new URLSearchParams(window.location.search);
    const universityParam = urlParams.get('university');
    const departmentParam = urlParams.get('department');

    // 如果有 URL 參數，自動選擇學校和學系
    if (universityParam && departmentParam) {
      loadUniversities().then(() => {
        const universitySelect = document.getElementById('university');
        universitySelect.value = decodeURIComponent(universityParam);
        
        loadDepartments(universityParam).then(() => {
          const departmentSelect = document.getElementById('department');
          departmentSelect.value = decodeURIComponent(departmentParam);
          
          // 載入學系指引
          loadGuidelines();
        });
      });
    } else {
      // 否則只載入學校列表
      loadUniversities();
    }
  });
</script>

{% endblock %}
