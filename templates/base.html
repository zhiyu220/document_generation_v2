<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <title>{% block title %}å‚™å¯©ç³»çµ±{% endblock %}</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <style>
      .paragraph-card {
        margin-bottom: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        overflow: hidden;
      }

      .upload-container {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
      }

      .upload-container input[type="file"] {
        margin-bottom: 5px;
      }

      .upload-container button {
        margin-left: 10px;
      }

      .paragraph-header {
        background-color: #f8f9fa;
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <div class="layout fade-in">
      <!-- === Sidebar === -->
      <aside class="sidebar">
        <h1 class="logo slide-up delay-1">ğŸ“„ å‚™å¯©ç³»çµ±</h1>
        <nav class="nav-menu slide-up delay-2">
          <h2>åŠŸèƒ½é¸å–®</h2>
          {% if current_user.is_authenticated %}
          <button
            class="tab {% if request.endpoint == 'profile' %}active{% endif %}"
            onclick="location.href='{{ url_for('profile') }}'"
          >
            ğŸ‘¤ æœƒå“¡ä¸­å¿ƒ
          </button>

          <button
            class="tab"
            onclick="location.href='{{ url_for('purchase') }}'"
          >
            ğŸ’³ å‡ç´šæ–¹æ¡ˆ
          </button>

          <button class="tab" onclick="location.href='{{ url_for('logout') }}'">
            ğŸšª ç™»å‡º
          </button>
          {% else %}
          <button
            class="tab {% if request.endpoint == 'login' %}active{% endif %}"
            onclick="location.href='{{ url_for('login') }}'"
          >
            ğŸ”‘ ç™»å…¥
          </button>

          <button
            class="tab {% if request.endpoint == 'register' %}active{% endif %}"
            onclick="location.href='{{ url_for('register') }}'"
          >
            ğŸ†• è¨»å†Š
          </button>
          {% endif %}

          <hr />

          <button
            class="tab {% if request.endpoint == 'index' %}active{% endif %}"
            onclick="location.href='{{ url_for('index') }}'"
          >
            ğŸ  é¦–é 
          </button>
          <button
            class="tab {% if request.endpoint == 'check_requirements' %}active{% endif %}"
            onclick="location.href='{{ url_for('show_check_page') }}'"
          >
            ğŸ“‹ å‚™å¯©æº–å‚™æŒ‡å¼•æŸ¥è©¢
          </button>
          <button
            class="tab {% if request.endpoint == 'generate_page' %}active{% endif %}"
            onclick="location.href='{{ url_for('generate_page') }}'"
          >
            ğŸ› ï¸ å‚™å¯©æ®µè½ç”Ÿæˆå™¨
          </button>
        </nav>
      </aside>

      <!-- === Main === -->
      <main class="main">
        <section class="content">{% block content %}{% endblock %}</section>
      </main>
    </div>

    {% include "qa_widget.html" %}

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        let selectedUniversity = "";
        let selectedDepartment = "";

        // è¼‰å…¥å­¸æ ¡æ¸…å–®
        fetch("/get_universities")
          .then((res) => res.json())
          .then((universities) => {
            const uniSelect = document.getElementById("chat-university");
            universities.forEach((uni) => {
              const opt = document.createElement("option");
              opt.value = uni;
              opt.textContent = uni;
              uniSelect.appendChild(opt);
            });

            uniSelect.addEventListener("change", () => {
              selectedUniversity = uniSelect.value;
              loadDepartments(selectedUniversity);
            });
          });

        // è¼‰å…¥å­¸ç³»æ¸…å–®
        function loadDepartments(university) {
          const deptSelect = document.getElementById("chat-department");
          deptSelect.innerHTML = '<option value="">è«‹é¸æ“‡å­¸ç³»</option>';

          fetch(`/get_departments?university=${encodeURIComponent(university)}`)
            .then((res) => res.json())
            .then((departments) => {
              departments.forEach((dept) => {
                const opt = document.createElement("option");
                opt.value = dept;
                opt.textContent = dept;
                deptSelect.appendChild(opt);
              });

              deptSelect.addEventListener("change", (e) => {
                selectedDepartment = e.target.value;
              });
            });
        }

        window.toggleChat = function () {
          document.getElementById("chat-window").classList.toggle("show");
        };

        window.sendMessage = function () {
          const input = document.getElementById("chat-input");
          const text = input.value.trim();
          if (!text || !selectedUniversity || !selectedDepartment) {
            appendMessage("â— è«‹å…ˆé¸æ“‡å­¸æ ¡èˆ‡å­¸ç³»ï¼Œå†è¼¸å…¥å•é¡Œï¼", "bot");
            return;
          }
          appendMessage(text, "user");
          input.value = "";
          appendMessage("â³ å›è¦†ä¸­...", "bot");

          fetch("/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              university: selectedUniversity,
              department: selectedDepartment,
              question: text,
            }),
          })
            .then((res) => res.json())
            .then((data) => {
              document.querySelectorAll(".message.bot").forEach((msg) => {
                if (msg.textContent.includes("å›è¦†ä¸­")) msg.remove();
              });
              appendMessage(data.answer || "âš ï¸ å›è¦†å¤±æ•—", "bot");
            });
        };

        function appendMessage(text, sender = "bot", isLoading = false) {
          const msg = document.createElement("div");
          msg.className = `message ${sender}`;
          if (isLoading) msg.dataset.loading = "true";

          // æ¸…é™¤ Markdown æ¨™è¨˜
          let cleaned = text
            .replace(/\*\*/g, "") // **ç²—é«”**
            .replace(/`/g, "") // `ç¨‹å¼ç¢¼`
            .replace(/[_~#>]/g, "") // å…¶ä»–ç¬¦è™Ÿ
            .replace(/\n{2,}/g, "\n") // å¤šé‡æ›è¡Œç°¡åŒ–æˆä¸€å€‹

            // é‡è¦ï¼šå°‡ A - ...ã€1. ...ã€B - ... å¼·åˆ¶æ–·è¡Œ
            .replace(/([A-Z])\s*-\s*/g, "\n$1 - ")
            .replace(/(\d+)\.\s*/g, "\n$1. ");

          // æ‹†æˆè¡Œï¼Œè½‰ç‚ºæ®µè½æˆ–æ¸…å–®
          const lines = cleaned.split("\n");
          const formattedLines = [];
          let inList = false;

          lines.forEach((line) => {
            const trimmed = line.trim();
            if (!trimmed) return;

            if (/^(\d+\.\s|[A-Z]-\s)/.test(trimmed)) {
              if (!inList) {
                formattedLines.push("<ul>");
                inList = true;
              }
              formattedLines.push(
                `<li>${trimmed.replace(/^(\d+\.\s|[A-Z]-\s)/, "")}</li>`
              );
            } else {
              if (inList) {
                formattedLines.push("</ul>");
                inList = false;
              }
              formattedLines.push(`<p>${trimmed}</p>`);
            }
          });
          if (inList) formattedLines.push("</ul>");

          msg.innerHTML = formattedLines.join("\n");
          document.getElementById("chat-body").appendChild(msg);
          document.getElementById("chat-body").scrollTop =
            document.getElementById("chat-body").scrollHeight;
        }
      });
    </script>
  </body>
</html>
